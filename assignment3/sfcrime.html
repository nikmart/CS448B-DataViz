<!DOCTYPE html>
<meta charset="utf-8">
<style>

text {
  font: bold 20px monospace;
}

.enter {
  fill: green;
}

.update {
  fill: #333;
}

.chart div {
  font: 10px sans-serif;
  background-color: grey;
  text-align: right;
  padding: 3px;
  margin: 1px;
  color: white;
}

.home {

}

</style>
<body>
<input type="button" id="button" value="Assault" onClick="showAssault()">
<input type="button" id="addHome" value="Add Home" onClick="addHome()">
<input type="range" min="0.1" max="7" step = "0.1" id="dataSlider" onChange="readRange()">
<br>
<input type="button" id="addWork" value="Add Work" onClick="addWork()">
<input type="range" min="0.1" max="7" step = "0.1" id="dataSlider" onChange="readRange()">
<br>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>

//.............. SF MAP ............//
// Set up size
var width = 750,
	height = width;

// Set up projection that map is using
var projection = d3.geo.mercator()
	.center([-122.433701, 37.767683]) // San Francisco, roughly
	.scale(225000)
	.translate([width / 2, height / 2]);


// Add an svg element to the DOM
var svg = d3.select("body").append("svg")
	.attr("width", width)
	.attr("height", height);

// Add svg map at correct size, assumes map is saved in a subdirectory called "data"
svg.append("image")
          .attr("width", width)
          .attr("height", height)
          .attr("xlink:href", "data/sf-map.svg");
//..................................//

var tooltip = d3.select("body")
	.append("div")
	.style("position", "absolute")
	.style("z-index", "10")
	.style("visibility", "hidden");

// var data = [[-122.458220811697, 37.7633123961354], [-122.447596140416, 37.7106886165247]]; //sample data
// console.log(data[1] + ", " + data[0]);

// loading the json data [2]
var crimes;

d3.json("data/scpd_incidents.json", function(error, json) {
  if (error) return console.warn(error);
  crimes = json;
  //console.log(json);
  mapIt(crimes);
});

function mapIt(data) {
  // put points down where the crimes happened using the data locations [1]
  // add circles to svg
  //console.log(data.data);
  svg.selectAll("circle")
      .data(data.data).enter()
  		.append("circle")
  		.attr("cx", function (d) { return projection(d.Location)[0]; })
  		.attr("cy", function (d) { return projection(d.Location)[1]; })
  		.attr("r", "2px")
  		.attr("fill", pickColor)
      .on("mouseover", function(d){
        tooltip.text(d.Category + ", "
          + d.Date);
        return tooltip.style("visibility", "visible");
      })
	    .on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
	    .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
      .attr("data-id", function(d){return d.Category;})
      .style("opacity", 0.3);

};

// set the color for each Category of crime [3]
var colors = d3.scale.category10().domain([0, 1, 2, 3, 4, 5, 6, 7, 8, 9]); //[6]
var pickColor = function (d) {
  switch (d.Category) {
    case "NON-CRIMINAL":
      //console.log(colors(0));
      return colors(0);

      break;

    case "LARCENY/THEFT":
      return colors(8);

      break;

    case "DRUG/NARCOTIC":
      return colors(2);

      break;

    case "VEHICLE THEFT":
      return colors(4);

      break;

    case "ASSAULT":
      return "red";
      //return colors(3);

      break;

    default:
      return colors(7);

  }
}

function showAssault(){
  console.log("Button clicked!");
  svg.selectAll("circle")
    .filter(function (d) { return d.Category === "ASSAULT";}) //[6]
    .attr("r", "4px");
  };



// Define drag beavior
var drag = d3.behavior.drag()
        .on('dragstart', function() { d3.select(this).attr("fill", "red"); })
        .on("drag", function(d,i) {
            d.x += d3.event.dx
            d.y += d3.event.dy
            d3.select(this).attr("transform", function(d,i){
                //console.log(d.x,d.y);
                return "translate(" + [ d.x,d.y ] + ")"
            })
          })
        .on('dragend', function(d) {
          console.log(d.x, d.y);
          //invert the pixel coordinates to lat/long for filtering
          var coords = projection.invert([d.x, d.y]); //[8]
          console.log(coords);
          d3.select(this).attr("fill", "black");
          filterHome(coords);
          //filter the dat to only show things within a certain mile range
        });

//Filter the data based on the house position
// get the postion of the house
// filter the data if it is within radius using a filter

var earthRad = 3959.547; //[10]
//compute the distance between the points [9]
var distRad = d3.geo.distance([-122.458220811697, 37.7633123961354],[-122.447596140416, 37.7106886165247]);
console.log("distance = " + distRad*earthRad);
var homeFilterDist = 50;

function filterHome(coords) {
  svg.selectAll("circle")
    .attr("r", function (d) {
      var dist = d3.geo.distance(coords, d.Location) * earthRad; //compute the distance
      //if the distance is less than 1 mi log it
      if (dist >= homeFilterDist) {
        //console.log(dist);
        return ; //return nothing to clear the circle radius
      }
      else{ return "2px";}
    })
}

//read the slider value of distance radius slider
function readRange(){
  var slider = document.getElementById('dataSlider').value;
  console.log("Slider:", slider);
  homeFilterDist = slider;
}

function addHome() {
  // Add the house and work points that you can drag [7]
  var home = svg.selectAll(".home").data([{ x: 0, y: 0 }])
  home.enter()
    .append("rect")
    .attr("x", function (d) {return d.x;})
    .attr("y", function (d) {return d.y;})
    .attr("width", 10)
    .attr("height", 10)
    .attr("fill", "black")
    .attr("transform", function(d,i){
        //console.log(d.x,d.y);
        d.x = 300;  //update the home to a nice spot on the map
        d.y = 400;
        return "translate(" + [ d.x, d.y ] + ")"
    })
    .call(drag);
}

function addWork() {
  // Add the house and work points that you can drag [7]
  var home = svg.selectAll(".work").data([{ x: 0, y: 0 }])
  home.enter()
    .append("rect")
    .attr("x", function (d) {return d.x;})
    .attr("y", function (d) {return d.y;})
    .attr("width", 10)
    .attr("height", 10)
    .attr("fill", "green")
    .attr("transform", function(d,i){
        //console.log(d.x,d.y);
        d.x = 500;  //update the work to a nice spot on the map near the waterfront
        d.y = 200;
        return "translate(" + [ d.x, d.y ] + ")"
    })
    .call(drag);
}

// References
  // [1] Plotting a point on a map: http://bl.ocks.org/phil-pedruco/7745589
  // [2] Loading JSON data: https://github.com/mbostock/d3/wiki/Requests
  // [3] Colors in d3: https://github.com/mbostock/d3/wiki/Ordinal-Scales#category10
                    // http://www.jeromecukier.net/blog/2011/08/11/d3-scales-and-color/
  // [4] Dynamic Filtering with HTML elements: https://gist.github.com/sytpp/3a070a6ed6834169a85b#file-ecoshoulds-tab
                                            // http://stackoverflow.com/questions/28922246/dynamic-filtering-in-d3-with-html-input
  // [5] Setting colors so domain is 0 - 9 to pick colors
  // [6] Filtering data using the filer function: http://stackoverflow.com/questions/25711108/how-to-select-elements-according-to-an-attributefill-color-in-d3-js-with-selec
  // [7] Dragable SVG elements: http://ssun.azurewebsites.net/creating-a-draggable-object-in-d3/
  // [8] Inverse pixel coordinates to lat/long: http://bl.ocks.org/nkhine/2876083
                                                //http://stackoverflow.com/questions/10884886/d3js-how-to-get-lat-log-geocoordinates-from-mouse-click
  // [9] Computing the distance between points on the map: https://github.com/mbostock/d3/wiki/Geo-Paths#distance
  // [10] Convert radians to miles on earth: http://stackoverflow.com/questions/3878702/mongodb-bound-queries-how-do-i-convert-mile-to-radian
  // [11] HTML range sliders: http://www.html5tutorial.info/html5-range.php
</script>
</body>
