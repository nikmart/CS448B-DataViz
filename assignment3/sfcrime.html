<!DOCTYPE html>
<meta charset="utf-8">
<style>

text {
  font: bold 20px monospace;
}

.enter {
  fill: green;
}

.update {
  fill: #333;
}

.chart div {
  font: 10px sans-serif;
  background-color: grey;
  text-align: right;
  padding: 3px;
  margin: 1px;
  color: white;
}

</style>
<body>
<input type="range" min="1" id="dataSlider">
<input type="button" id="button" value="Assault" onClick="showAssault()">
<input type="button" id="button" value="Battery" onClick="showBattery()">
<script src="//d3js.org/d3.v3.min.js"></script>
<script>

//.............. SF MAP ............//
// Set up size
var width = 750,
	height = width;

// Set up projection that map is using
var projection = d3.geo.mercator()
	.center([-122.433701, 37.767683]) // San Francisco, roughly
	.scale(225000)
	.translate([width / 2, height / 2]);


// Add an svg element to the DOM
var svg = d3.select("body").append("svg")
	.attr("width", width)
	.attr("height", height);

// Add svg map at correct size, assumes map is saved in a subdirectory called "data"
svg.append("image")
          .attr("width", width)
          .attr("height", height)
          .attr("xlink:href", "data/sf-map.svg");
//..................................//

var tooltip = d3.select("body")
	.append("div")
	.style("position", "absolute")
	.style("z-index", "10")
	.style("visibility", "hidden");

// var data = [[-122.458220811697, 37.7633123961354], [-122.447596140416, 37.7106886165247]]; //sample data
// console.log(data[1] + ", " + data[0]);

// loading the json data [2]
var crimes;

d3.json("data/scpd_incidents.json", function(error, json) {
  if (error) return console.warn(error);
  crimes = json;
  //console.log(json);
  mapIt(crimes);
});

function mapIt(data) {
  // put points down where the crimes happened using the data locations [1]
  // add circles to svg
  //console.log(data.data);
  svg.selectAll("circle")
      .data(data.data).enter()
  		.append("circle")
  		.attr("cx", function (d) { return projection(d.Location)[0]; })
  		.attr("cy", function (d) { return projection(d.Location)[1]; })
  		.attr("r", "2px")
  		.attr("fill", pickColor)
      .on("mouseover", function(d){
        tooltip.text(d.Category + ", "
          + d.Date);
        return tooltip.style("visibility", "visible");
      })
	    .on("mousemove", function(){return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
	    .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
      .attr("data-id", function(d){return d.Category;})
      .style("opacity", 0.3);

};

// set the color for each Category of crime [3]
var colors = d3.scale.category10().domain([0, 1, 2, 3, 4, 5, 6, 7, 8, 9]); //[6]
var pickColor = function (d) {
  switch (d.Category) {
    case "NON-CRIMINAL":
      //console.log(colors(0));
      return colors(0);

      break;

    case "LARCENY/THEFT":
      return colors(8);

      break;

    case "DRUG/NARCOTIC":
      return colors(2);

      break;

    case "VEHICLE THEFT":
      return colors(4);

      break;

    case "ASSAULT":
      return "red";
      //return colors(3);

      break;

    default:
      return colors(7);

  }
}

function showAssault(){
  console.log("Button clicked!");
  svg.selectAll("circle")
    .filter(function (d) { return d.Category === "ASSAULT";}) //[6]
    .attr("r", "4px");
  };

function showBattery() {

}

// Define drag beavior
var drag = d3.behavior.drag()
        .on("drag", function(d,i) {
            d.x += d3.event.dx
            d.y += d3.event.dy
            d3.select(this).attr("transform", function(d,i){
                console.log(d.x,d.y);
                return "translate(" + [ d.x,d.y ] + ")"
            })
        });


// Add the house and work points that you can drag [7]
var home = svg.selectAll(".home")
  .data([{ x: 0, y: 0 }])
  .enter()
  .append("rect")
  .attr("x", function (d) {return d.x;})
  .attr("y", function (d) {return d.y;})
  .attr("width", 10)
  .attr("height", 10)
  .attr("fill", "black")
  .call(drag);









// References
  // [1] Plotting a point on a map: http://bl.ocks.org/phil-pedruco/7745589
  // [2] Loading JSON data: https://github.com/mbostock/d3/wiki/Requests
  // [3] Colors in d3: https://github.com/mbostock/d3/wiki/Ordinal-Scales#category10
                    // http://www.jeromecukier.net/blog/2011/08/11/d3-scales-and-color/
  // [4] Dynamic Filtering with HTML elements: https://gist.github.com/sytpp/3a070a6ed6834169a85b#file-ecoshoulds-tab
                                            // http://stackoverflow.com/questions/28922246/dynamic-filtering-in-d3-with-html-input
  // [5] Setting colors so domain is 0 - 9 to pick colors
  // [6] Filtering data using the filer function: http://stackoverflow.com/questions/25711108/how-to-select-elements-according-to-an-attributefill-color-in-d3-js-with-selec
  // [7] Dragable SVG elements: http://ssun.azurewebsites.net/creating-a-draggable-object-in-d3/
</script>
</body>
